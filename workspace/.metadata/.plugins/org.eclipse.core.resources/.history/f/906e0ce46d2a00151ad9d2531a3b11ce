package com.klt.connectior;

import java.io.IOException;
import java.io.InputStream;

import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.HttpRequestBase;
import org.apache.http.impl.client.DefaultHttpClient;
import org.json.JSONObject;

import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.util.Log;

public class KLTHttpClient {

	public static final String HOST = "210.118.74.204";
	public static final int PORT = 38273;
	
	private static final String TAG = "KLTHttpClient";
	
	private static KLTHttpClient instance = null;
	
	private HttpClient httpClient = null;
	
	private KLTHttpClient() {
		httpClient =  new DefaultHttpClient();
	}
	
	public static KLTHttpClient getInstance() {
		if (instance == null) {
			instance = new KLTHttpClient();
		}	
		return instance;
	}
	
	public synchronized static void background(final HttpRequestBase request, final Handler callback) throws IOException {
		new Thread(new Runnable() {
			@Override
			public void run() {
				try {
					Message msg = new Message();
					msg.what = 1;

					Bundle data = new Bundle();
					data.putString("res", KLTHttpClient.getInstance().excute(request));
					
					msg.setData(data);
					callback.sendMessage(msg);
				} catch (Exception e) {
					e.printStackTrace();
					callback.sendEmptyMessage(-1);
				}
			}
		}).start();
	}
		
	/**
	 * Server로 부터 응답을 받았을때 호출한다.
	 * getInstence 메소드를 호출했을때 설정한 Handler에 response의 데이터를 전달한다.
	 * 
	 * 설정할 Handler에선 다음과 같이 데이터를 받을 수 있다.
	 * httpStatusCode:  mssage.getData().getInt("httpStatusCode");
	 * JSONArray:  mssage.getData().getString("res");
	 * 
	 * mssage.getData().getString("res")로 받아서 new JSONArray(res) 생성해 사용하시면 됩니다.
	 * 
	 * */
	final ResponseHandler<String> responseHandler = new ResponseHandler<String>() {
		@Override
		public String handleResponse(HttpResponse response) {
			Log.d(TAG, "handleResponse() start");
			JSONObject result = new JSONObject();
			
			try {
				if(response.getHeaders("Set-Cookie").length > 0)
					result.put("Set-Cookie", response.getHeaders("Set-Cookie")[0].getValue());
				
				result.put("httpStatusCode", response.getStatusLine().getStatusCode());
				StringBuffer sb = new StringBuffer();
				byte[] b = new byte[1024];
				
				long langht = response.getEntity().getContentLength();
				int index;				
				InputStream is = response.getEntity().getContent();
				for(int  n=0;  n < langht; n+=index){
					
					if((index = is.read(b)) > 0)
						sb.append(new String(b, 0, index));
					else
						Log.e(TAG, "read value is " + index);
				}
				
				result.put("res", sb.toString() );
			} catch (Exception e) {
				Log.e(TAG, "err: " + e.getMessage());
			} finally{
//				message.setData(data);
//				mHandle.sendMessage(message);
			}
			
			return result.toString();
		}
	};
	
	public String excute(final HttpRequestBase httpRequest) throws IOException {
		String resStr = httpClient.execute(httpRequest, responseHandler);
		return resStr;
	}
	
	public static final String getBaseURL() {
		return "http://" + HOST + ":" + PORT;
	}
	
	public static void close() {
		instance = null;
	}
	
}
