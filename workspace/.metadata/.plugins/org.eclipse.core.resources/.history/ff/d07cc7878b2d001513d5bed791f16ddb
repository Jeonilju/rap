package com.klt.activity;

import java.util.ArrayList;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.app.AlertDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.Button;
import android.widget.ListView;

import com.klt.BaseActivity;
import com.klt.R;
import com.klt.data.OrderInfo;
import com.klt.view.OrderListAdapter;

public class OrderListActivity extends BaseActivity {

	private ListView orderList = null;
	private ArrayList<OrderInfo> adapterList;
	private OrderListAdapter adapter;

	private Button btnReSearchOrder;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		setContentView(R.layout.activity_order_list);
		setTitle(getString(R.string.title_order_list));
		super.onCreate(savedInstanceState, this);

		initResource();
		initEvent();
		
		Intent intent = getIntent();
		String data = intent.getStringExtra("data");
		initData(data);
	}

	private void initResource() {
		adapterList = new ArrayList<OrderInfo>();
		adapter = new OrderListAdapter(OrderListActivity.this, adapterList, true);
		orderList = (ListView) findViewById(R.id.order_search_list);
		orderList.setAdapter(adapter);

		btnReSearchOrder = (Button) findViewById(R.id.orderlist_btn_research);
	}
	
	private void initData(String data){
		try {
			JSONObject obj = new JSONObject(data);
			JSONObject json = new JSONObject(obj.getString("res"));
			JSONArray orders = new JSONArray(json.getString("orders"));
			
			if(orders.length() == 0){
				// 데이터 없음
				ShowDig("검색 결과가 없습니다.");
				return;
			}
			
			for(int n=0;n < orders.length();n++){
				
				try
				{
					OrderInfo info = new OrderInfo(
							orders.getJSONObject(n).getInt("id")
							, orders.getJSONObject(n).getString("address")
							, orders.getJSONObject(n).getString("detail_address")
							, orders.getJSONObject(n).getInt("floor")
							, orders.getJSONObject(n).getDouble("ton")
							, orders.getJSONObject(n).getDouble("date")
							, orders.getJSONObject(n).getInt("price")
							, orders.getJSONObject(n).getInt("status"));
					
					info.master_commission = "" + orders.getJSONObject(n).getInt("master_commission");
					info.admin_commission = "" + orders.getJSONObject(n).getInt("admin_commission");
					info.orderer_commission = "" + orders.getJSONObject(n).getInt("orderer_commission");
					
					adapterList.add(info);
				}
				catch(JSONException e)
				{
					 continue;
				}
				
			}
			
		} catch (JSONException e) {
			e.printStackTrace();
		}
		
	}

	private void initEvent() {
		orderList.setOnItemClickListener(new OnItemClickListener() {

			@Override
			public void onItemClick(AdapterView<?> parent, View view,
					int position, long id) {

			}
		});

		btnReSearchOrder.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View v) {
				finish();
			}
		});
	}

	private void ShowDig(String message){
		AlertDialog.Builder alt_bld = new AlertDialog.Builder(
				OrderListActivity.this);

		alt_bld.setMessage(message)
				.setCancelable(false)
				.setPositiveButton(getString(R.string.close),
						new DialogInterface.OnClickListener() {
							public void onClick(DialogInterface dialog,
									int id) {
								finish();
							}
						});

		AlertDialog alert = alt_bld.create();
		alert.setTitle("");
		alert.show();
	}
	
}
